<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Map (WMS + GetFeatureInfo)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
        #map { height: 100%; width: 70%; }
        #infoDiv {
            height: 100%;
            width: 30%;
            overflow: auto;
            padding: 15px;
            background: #f1f1f1;
            font-size: 14px;
            box-sizing: border-box;
            border-left: 1px solid #ddd;
        }
        #infoDiv h3 { color: #4CAF50; }
        #infoDiv table { width: 100%; border-collapse: collapse; }
        #infoDiv th, #infoDiv td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        #infoDiv th { background-color: #4CAF50; color: white; }
        #infoDiv td { background-color: #f9f9f9; }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="infoDiv">
        <h3>Feature Information</h3>
        <p>Click on the map to display feature information.</p>
        <table id="infoTable">
            <tr>
                <th>Attribute</th>
                <th>Value</th>
            </tr>
            <tr><td>Feature Type</td><td id="featureType">N/A</td></tr>
            <tr><td>Gray Index</td><td id="grayIndex">N/A</td></tr>
            <tr><td>Layer Name</td><td id="layerName">N/A</td></tr>
            <tr><td>Coordinates</td><td id="coordinates">N/A</td></tr>
        </table>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        // 1) ساخت نقشه
        const map = L.map("map").setView([51.505, -0.09], 12);

        // 2) بیس‌مپ OSM
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        // 3) WMS عمومی (terrestris)
        const wmsUrl = "https://ows.terrestris.de/osm/service?";
        const wmsLayerName = "OSM-WMS";

        const wmsLayer = L.tileLayer.wms(wmsUrl, {
            layers: wmsLayerName,
            format: "image/png",
            transparent: true
        }).addTo(map);

        // کمک: bbox در EPSG:3857 (چون Leaflet پیش‌فرض 3857 هست)
        function getBbox3857(map) {
            const b = map.getBounds();
            const sw = map.options.crs.project(b.getSouthWest());
            const ne = map.options.crs.project(b.getNorthEast());
            return `${sw.x},${sw.y},${ne.x},${ne.y}`;
        }

        // 4) ساخت URL برای GetFeatureInfo (WMS 1.3.0)
        function getFeatureInfoUrl(e) {
            const point = map.latLngToContainerPoint(e.latlng, map.getZoom());
            const size = map.getSize();

            const params = {
                service: "WMS",
                request: "GetFeatureInfo",
                version: "1.3.0",
                layers: wmsLayerName,
                query_layers: wmsLayerName,
                bbox: getBbox3857(map),
                crs: "EPSG:3857",
                width: size.x,
                height: size.y,
                i: Math.round(point.x),
                j: Math.round(point.y),
                info_format: "text/html",  // تغییر فرمت به HTML
                feature_count: 5
            };

            const query = new URLSearchParams(params).toString();
            return wmsUrl + query;
        }

        // 5) کلیک روی نقشه
        map.on("click", (e) => {
            const url = getFeatureInfoUrl(e);
            console.log("GetFeatureInfo URL:", url);

            fetch(url)
                .then((r) => r.text())
                .then((html) => {
                    document.getElementById("infoDiv").innerHTML = html || "هیچ اطلاعاتی برنگشت.";
                })
                .catch((err) => {
                    console.error(err);
                    document.getElementById("infoDiv").innerHTML = "خطا در گرفتن اطلاعات. کنسول مرورگر (F12) رو چک کن.";
                });
        });
    </script>

</body>
</html>